<head>
<style>
@font-face {
    font-family: StarJedi;
    src: url(Starjedi.ttf);
}

.preset {
  border-radius: 15px 50px;
  border: 2px solid #6060aa;
  background: #101040;
  color: #FFFFFF;
  width: 250px;
  height: 80px;
  text-align: center;
  margin: 3px;
  padding: 8px;
}

.title {
  font-family: StarJedi;
  font-size: 250%;
  line-height: 0.6;
}

</style>	    
<script src=sha1.js></script>
</head>
<body>
  <H2>This is a test of the emergency broadcast WEB BLUETOOTH SYSTEM</h2>

<script>

var rx;
var tx;
var pw;
var status;

var send_queue = [];
var status_cb;

var buffer = "";

function SendNext() {
  tx.writeValue(new TextEncoder('utf-8').encode(send_queue[0][0] + '\n'));
}

function OnRX(event) {
  var data = new TextDecoder().decode(event.target.value);
  buffer += data;
  var tmp = buffer.split("-+=END_OUTPUT=+-");
  if (tmp.length > 1) {
    buffer = tmp[1];
    var ret = tmp[0];
    tmp = ret.split("-+=BEGIN_OUTPUT=+-");
    if (tmp.length > 1) ret = tmp[1];
    console.log('> ' + ret);
    send_queue[0][1](ret);
    send_queue = send_queue.slice(1);
    if (send_queue.length > 0) SendNext();
  }
}

function Send(cmd) {
  // needs to fail on timeout
  return new Promise(function(resolve, reject) {
    send_queue.push( [cmd, resolve] );
    if (send_queue.length == 1) SendNext();
  });
}

function OnStatus(event) {
  console.log("ONSTATUS");
  var data = new TextDecoder().decode(event.target.value);
  console.log('STATUS> ' + data);
  if (status_cb) {
     status_cb(data);
     status_cb = 0;
  }
}

function SendPW(password) {
  // needs to fail on timeout
  return new Promise(function(resolve, reject) {
    status_cb = resolve;
    pw.writeValue(new TextEncoder('utf-8').encode(password));
  });
}

async function SetPreset(n) {
  return Send("set_preset " + n);
}

function SendField() {
  var value = document.getElementById('textField').value + '\n';
  document.getElementById('textField').value = "";
  let encoder = new TextEncoder('utf-8');
  tx.writeValue(encoder.encode(value));
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function dumpChar(c) {
  console.log('> UUID:                 ' + c.uuid);
  console.log('> Broadcast:            ' + c.properties.broadcast);
  console.log('> Read:                 ' + c.properties.read);
  console.log('> Write w/o response:   ' + c.properties.writeWithoutResponse);
  console.log('> Write:                ' + c.properties.write);
  console.log('> Notify:               ' + c.properties.notify);
  console.log('> Indicate:             ' + c.properties.indicate);
  console.log('> Signed Write:         ' + c.properties.authenticatedSignedWrites);
  console.log('> Queued Write:         ' + c.properties.reliableWrite);
  console.log('> Writable Auxiliaries: ' + c.properties.writableAuxiliaries);
}

async function Run() {
  let serviceUuid = '713d0000-389c-f637-b1d7-91b361ae7678';
  let rxUuid = '713d0002-389c-f637-b1d7-91b361ae7678';
  let txUuid = '713d0003-389c-f637-b1d7-91b361ae7678';
  let pwUuid = '713d0004-389c-f637-b1d7-91b361ae7678';
  let statusUuid = '713d0005-389c-f637-b1d7-91b361ae7678';

  console.log('Requesting Bluetooth Device...');
  const device = await navigator.bluetooth.requestDevice({
//         acceptAllDevices: true,
//       optionalServices: [serviceUuid],
     filters: [{services: [serviceUuid]}]
  });

  console.log('Connecting to GATT Server...');
  const server = await device.gatt.connect();
  console.log(server)

  console.log('Getting Service...');
  const service = await server.getPrimaryService(serviceUuid);
  console.log(service)

  console.log('Getting Characteristics...');
  rx = await service.getCharacteristic(rxUuid);
  tx = await service.getCharacteristic(txUuid);
  pw = await service.getCharacteristic(pwUuid);
  status = await service.getCharacteristic(statusUuid);

  dumpChar(rx);
  dumpChar(tx);
  dumpChar(pw);
  dumpChar(status);

  console.log("StartNotify");
  await rx.startNotifications();
  rx.addEventListener('characteristicvaluechanged', OnRX);

  await status.startNotifications();
  status.addEventListener('characteristicvaluechanged', OnStatus);

  console.log("Sending PW");
  var status = await SendPW(document.getElementById('password').value);
  if (status == "OK") {
    console.log("Authenticated.");
  } else {
    console.log("WRONG PASSWORD!");
    // TODO: something
  }

  var preset;
  var presets = [];
  var preset_string = await Send("list_presets");
  const lines = preset_string.split("\n");
  for (var l = 0; l < lines.length; l++) {
    var tmp = lines[l].split("=");
    console.log(tmp);
    if (tmp.length > 1) {
      if (tmp[0] == "FONT") {
        if (preset) presets.push(preset);
        preset = {}
      }
      preset[tmp[0]] = tmp.slice(1).join("=");
    }
  }

  console.log(presets);

  preset_string = "";
  for (var i = 0; i < presets.length; i++) {
    var p = presets[i];
    preset_string += "<div class=preset onclick='SetPreset(" + i + ")'>";
    preset_string += "<span class=title>" + p.NAME.replace("\\n", "<br>") + "</span>";
    preset_string += "</div>";
  }
  document.getElementById('presets').innerHTML = preset_string;

  while (true) {
    const voltage = await Send("battery_voltage");
    document.getElementById('voltage').innerHTML = voltage;
    // TODO: temp
    await sleep(5000);
  }
}

</script>

Password: <input type=password id=password onkeydown="if (event.keyCode == 13) Run();"><button type=button onclick='Run()'>Connect</button>
<br>
Send Command: <input type=text id=textField onkeydown="if (event.keyCode == 13) SendField();"><br>
Voltage: <span id=voltage>---</span><br>
<span id=presets>
</span>
</body>

